# Austrian Flood Monitor - Backend

Welcome to the Client application of the Austrian Flood Monitor project. This is the backend part comprising of a Bun + Elysia.js server with a PostgreSQL database managed with Prisma ORM.

See the top level [README.md here](../README.md).

## Structure of `server`

The `server` directory contains the Bun + Elysia.js backend application and database setup logic using Prisma. In general API endpoints can be created from the `src` folder and changes to the database can be done inside the `prisma.schema` file.

You can find actual database queries made via Prisma Client in the `sql.ts` if you want to create any new query, write it here. And use it inside the `index.ts` or any other route of the Elysia application.

> [!IMPORTANT]  
> Database changes must be migrated by starting the database and then running `DATABASE_URL=postgres://postgres:your-super-secret-and-long-postgres-password@localhost:5432/postgres npx prisma migrate dev` inside the `server` directory. This will create a new migration SQL file inside `./prisma/migrations`.

```plaintext
server
├── .env
│   └── For storing local variables and secrets - db setup
├── .gitignore
├── bun.lockb
│   └── Lockfile used by Bun, similar to package lock
├── package.json
├── tsconfig.json
└── README.md (<- You are reading me)
├── prisma/
│   ├── migrations/
│   │   └── Here are the raw SQL migrations generated by Prisma, add custom SQL here
│   ├── schema.prisma
│   │   └── This is where you set up the tables and the DB
│   └── utils/
│       └── seed.mjs (<- seeding logic)
└── src/
    ├── index.ts
    │   └── The central point of the server, import all routes, middleware and handlers
    ├── [example.ts]
    │   └── Other additional routes can be declared outside of `index.ts` and imported there
    ├── prisma.ts
    │   └── Prisma client setup
    └── sql.ts
        └── Any raw SQL or Prisma query goes here to be reusable
```

## Prerequisites

Get the `.env` file as outlined in the [main README](../README.md) and copy it here, into the root of the `server` directory.

Additionally, you need:
- Node.js (v16 or later)
- Bun
- Docker

And run `bun install` once before running anything locally.

## Starting the backend

The backend can be started from the `server` directory of the application using a `docker-compose` file. This file has three services, first one initiates the database and another one that sets up the database, applying the Prisma schema, migrations, running a seeding script and then the Bun server also starts up.

```sh
docker-compose up
```

## Quick guide for contributing

All you have to worry about in this directory is the `src` and `prisma` directory.

### Make changes to the server

- Inside `src` define handlers on `index.ts` directly or group them logically in separate components, importing and `.use()`-ing them in `index.ts`.
- After each change you have to restart the whole backend with `docker compose`, there is no hot reloading as of now.

### Make changes to the database

- Make changes to the table definitions inside `./prisma/schema.prisma`, if you need custom change that Prisma can not provide, you can make changes directly to SQL migrations.
- Once you have made changes you have to migrate them with: 
    ```sh
    DIRECT_URL=postgres://postgres:your-super-secret-and-long-postgres-password@localhost:5432/postgres npx prisma migrate dev
    ```
- Make sure to also update the prepopulated data inside `./prisma/utils/seed.mjs` to fit the new schema.

### Overview the database

You can start a `Prisma Studio` web interface through which you can see and manipulate data inside the database, real time:

```sh
DATABASE_URL=postgres://postgres:your-super-secret-and-long-postgres-password@localhost:5432/postgres npx prisma studio
```

### Swagger UI

The backend also implements Swagger UI based docs, giving you a quick overivew of the available endpoints, and allowing you to send requests to them directly from the web interface. The interface can be found on the `/docs` endpoint of the server url, meaning that you can find it from your browser at:
[http://localhost:9512/docs](http://localhost:9512/docs)

## Relevant docs and guides online

- [Elysia.js](https://elysiajs.com/integrations/cheat-sheet.html)
- [Prisma](https://www.prisma.io/docs/orm)
- [Bun](https://bun.sh/docs)
- [TypeScript](https://www.typescriptlang.org/docs/)